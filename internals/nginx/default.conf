limit_req_zone $request_uri zone=by_url:10m rate=30r/s;

server {
        listen 8080 default_server;
        listen [::]:8080 default_server;

        server_name nodeserver;

        add_header Access-Control-Allow-Origin "data.amsterdam.nl";
        add_header Access-Control-Allow-Origin "acc.data.amsterdam.nl";
        add_header Access-Control-Allow-Origin "localhost";

        location / {
                limit_req zone=by_url;

                proxy_http_version 1.1;
                proxy_cache_bypass $http_upgrade;

                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                proxy_pass http://nodejs:8080;
        }
}
